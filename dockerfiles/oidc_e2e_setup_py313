FROM python:3.13.10-bookworm

EXPOSE 8080 8081

RUN pip install --no-cache-dir virtualenv && \
    virtualenv /testrp_env && \
    virtualenv /testprovider_env

COPY testprovider /testprovider/
COPY testrp /testrp/

RUN . /testprovider_env/bin/activate && pip install --no-cache-dir -r /testprovider/requirements.txt && \
    . /testrp_env/bin/activate && pip install --no-cache-dir -r /testrp/requirements.txt

RUN apt-get update && \
    apt-get install -y --no-install-recommends wait-for-it firefox-esr && \
    wget "https://download.mozilla.org/?product=firefox-latest&os=linux64&lang=en-US" -O /tmp/firefox.tar.bz2 && \
    tar xvf /tmp/firefox.tar.bz2 -C /opt && \
    rm /usr/bin/firefox /tmp/firefox.tar.bz2 && \
    ln -s /opt/firefox/firefox /usr/bin/firefox && \
    wget "https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-linux64.tar.gz" -O /tmp/geckodriver.tar.gz && \
    tar xvf /tmp/geckodriver.tar.gz -C /opt && \
    rm /tmp/geckodriver.tar.gz && \
    ln -s /opt/geckodriver /usr/bin/geckodriver && \
    rm -rf /var/lib/apt/lists/*

RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /testprovider /testrp /testrp_env /testprovider_env

USER appuser
